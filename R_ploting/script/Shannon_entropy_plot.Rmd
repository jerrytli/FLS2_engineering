---
title: "Shannon Entropy"
output: html_document
date: "2024-03-16"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
  
```{r}
library(ggplot2)
library(zoo)
```


### Normalized Shanon Entropy calculated using Sr33 Sr50 paper's code
```{r}

entropy <- read.table('../input/entropylist.tsv',sep = '\t', header = TRUE)
```

```{r}
# Define the custom ggplot theme
my_ggplot_theme <- theme_classic() +
  theme(text = element_text(size = 16),
        axis.title.x = element_text(size = 14, color = "black"),
        axis.title.y = element_text(size = 14, color = "black"),
        axis.text.x = element_text(size = 14, color = "black"),
        axis.text.y = element_text(size = 14, color = "black"),
        axis.ticks = element_line(size = 0.8))


# Create the plot with vertical lines at specified positions and apply the custom theme
p <- ggplot(filter(entropy, Order == "Rosales"), aes(x = Position, y = Entropy, color = Order)) +
    geom_line(size = 1.0) + # Adjust this value to make the line thicker
    #geom_smooth(se = FALSE, method = "loess", span = 0.1, color = "black") + # Add a smooth curve (change span for smoothness)
    geom_vline(xintercept = c(247, 391, 412, 439, 460), color = "red", alpha = 0.3) +
    geom_hline(yintercept = (1.5/log2(20)), col = "red") +
    my_ggplot_theme +
    scale_y_continuous(expand = c(0, 0), limits = c(0, 0.8)) + # Set y-axis max to 9
    scale_x_continuous(expand = c(0, 0), breaks = seq(100, 700, by = 100)) + # Set x-axis breaks at every 100 units
    labs(title = "Fagales",
         x = "Amino Acid Position",
         y = "Normalized Shannon Entropy")

# Save the plot to a file
ggsave("../output/Fagales_entropy.pdf", plot = p, width = 10, height = 5, dpi = 300)

# Print the plot to the R console
print(p)

```


####Plot dN/dS at region 1
```{r}
# Load necessary libraries
library(ggplot2)
library(dplyr)

# Read the data
entropy <- read.table('../input/entropylist.tsv',sep = '\t', header = TRUE)

# Function to extract data for a specified range and group
extract_entropy <- function(data, group_name, start_pos, end_pos) {
  data %>%
    filter(Order == group_name & Position >= start_pos & Position <= end_pos) %>%
    mutate(relative_pos = Position - start_pos + 1) # Create a new column for relative position (1 to 24)
}

# Define ranges for each group
fagales_range <- c(216, 263)
brassicales_range <- c(219, 266)
rosales_range <- c(216, 263)

# Extract data for each range
fagales_entropy_region_1 <- extract_entropy(entropy, "Fagales", fagales_range[1], fagales_range[2])
brassicales_entropy_region_1 <- extract_entropy(entropy, "brassicales", brassicales_range[1], brassicales_range[2])
rosales_entropy_region_1 <- extract_entropy(entropy, "Rosales", rosales_range[1], rosales_range[2])

# Combine extracted data and set custom colors
combined_data <- rbind(
  fagales_entropy_region_1 %>% mutate(Order = "Fagales"),
  brassicales_entropy_region_1 %>% mutate(Order = "Brassicales"),
  rosales_entropy_region_1 %>% mutate(Order = "Rosales")
) %>% 
  mutate(color = ifelse(`Entropy` > 0.347, case_when(
    Order == "Brassicales" ~ "#66C2A5",
    Order == "Fagales" ~ "#C84D4C",
    Order == "Rosales" ~ "#8DA0CB"
  ), case_when(
    Order == "Brassicales" ~ "gray75",
    Order == "Fagales" ~ "gray73",
    Order == "Rosales" ~ "gray77"
  )))

# Plot with custom color rules and a red line for entropy = 0.347
ggplot(combined_data, aes(x = relative_pos, y = `Entropy`, fill = color)) +
  geom_bar(stat = "identity", position = position_dodge(), width = 0.85) +
  geom_hline(yintercept = 0.347, color = "red", linetype = "dashed") +
  scale_fill_identity() + # Use the actual colors specified in the data frame
  scale_x_continuous(expand = c(0, 0), breaks = c(0, 11, 25, 35, 48), labels = c("0"," ", "25", " ", "48")) +
  scale_y_continuous(expand = c(0, 0)) + # Remove padding in y-axis
  labs(x = "Amino Acid Position", y = "Normalized Shannon Entropy" )+
  theme_classic() +
   theme(legend.position = "right",
         axis.text.x = element_text(size = 15, color = "black"),
        axis.text.y = element_text(size = 15, color = "black"),
        axis.title.y = element_text(size = 15, color = "black"),
        axis.title.x = element_blank())
ggsave("../output/entropy_region_1.pdf", width = 6, height = 3)

```

Map entropy score to LRR 1 to 28, concave surface exposed residues (no backbone hydrophobic residues)
```{r}
library(dplyr)
library(readr)
library(tidyr)

# Read the entropy scores file
entropy_scores <- read_delim("../input/entropylist.tsv", delim = "\t")

# Function to process each dataset
process_dataset <- function(coordinates_path, order) {
  # Read coordinates file
  coordinates <- read_csv(coordinates_path, show_col_types = FALSE)
  
  # Check and adjust column names if necessary
  if (!"LRR" %in% names(coordinates)) {
    names(coordinates)[1] <- "LRR"  # Assuming the first column is the LRR column
  }
  
  # Reshape coordinates to long format
  coordinates_long <- pivot_longer(coordinates, cols = -LRR, names_to = "residue", values_to = "Position")
  
  # Filter entropy scores for the specific order and join
  entropy_scores_filtered <- filter(entropy_scores, Order == order)
  joined_data <- left_join(coordinates_long, entropy_scores_filtered, by = "Position")
  
  # Reshape back to wide format
  entropy_table <- pivot_wider(joined_data, names_from = "residue", values_from = "Entropy", id_cols = "LRR")
  
  # Calculate the average entropy for each LRR
  entropy_table$Average_Entropy <- rowMeans(entropy_table[,-1], na.rm = TRUE)  # Excluding the LRR column from average calculation

  # Output the modified table with average entropy column
  write_csv(entropy_table, paste0("../output/", order, "_entropy_scores.csv"))
}

# Apply the function to each dataset
process_dataset("../input/fagales_LRRexposed_residue_coordinates.csv", "Fagales")
process_dataset("../input/rosales_LRRexposed_residue_coordinates.csv", "Rosales")
process_dataset("../input/brassicales_LRRexposed_residue_coordinates.csv", "Brassicales")

```

Take a look of the curves

```{r}
library(ggplot2)
library(readr)

# Load the data
lrr_entropy <- read_csv("../output/LRR_entropy.csv")

# Creating the plot
plot <- ggplot(lrr_entropy, aes(x = LRR)) +
  geom_line(aes(y = Brassicales, color = "Brassicales"), size = 1) +
  geom_point(aes(y = Brassicales, color = "Brassicales")) +
  geom_line(aes(y = Fagales, color = "Fagales"), size = 1) +
  geom_point(aes(y = Fagales, color = "Fagales")) +
  geom_line(aes(y = Rosales, color = "Rosales"), size = 1) +
  geom_point(aes(y = Rosales, color = "Rosales")) +
  labs(title = "Average Entropy Scores of Concave Surface Exposed Residues Across LRR Repeats",
       x = "LRR Repeat",
       y = "Entropy Score") +
  scale_color_manual(values = c("Brassicales" = "#6a3d9a", "Fagales" = "#33a02c", "Rosales" = "#ff7f00")) +
  theme_classic()

# Display the plot
print(plot)

```