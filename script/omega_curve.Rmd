  
```{r}
library(ggplot2)
library(zoo)
```

```{r}

omega <- read.csv('../input/fagales_omega.csv')

# Calculate the sliding window average
window_size <- 25
omega$Sliding_Average <- zoo::rollapply(omega$dN.dS, 
                                                      width = window_size, 
                                                      by = 1, 
                                                      FUN = mean, 
                                                      align = 'center', 
                                                      fill = NA)
# Define the custom ggplot theme
my_ggplot_theme <- theme_linedraw() +
  theme(text = element_text(size = 16, family = "Helvetica"),
        axis.title.x = element_text(size = 14, color = "black", family = "Helvetica"),
        axis.title.y = element_text(size = 14, color = "black", family = "Helvetica"),
        axis.text.x = element_text(size = 12, color = "black", family = "Helvetica"),
        axis.text.y = element_text(size = 14, color = "black", family = "Helvetica"),
        axis.ticks = element_line(size = 0.8),
        axis.ticks.length.y = unit(1.5, "mm"),
        plot.background = element_rect(fill = "white"),
        panel.grid = element_blank(), 
        panel.border = element_rect(color = "black", size = 0.8))

# Create the plot with vertical lines at specified positions and apply the custom theme
p <- ggplot(omega, aes(x = pos, y = Sliding_Average)) +
    #geom_line(size = 1.0) + # Adjust this value to make the line thicker
    geom_smooth(se = FALSE, method = "loess", span = 0.05, color = "black") + # Add a smooth curve (change span for smoothness)
    geom_vline(xintercept = c(247, 391, 412, 439, 460), color = "red", linetype = "longdash") +
    my_ggplot_theme +
    #scale_y_continuous(limits = c(-1, 5)) + # Set y-axis max to 9
    scale_x_continuous(breaks = seq(100, 700, by = 100)) + # Set x-axis breaks at every 100 units
    labs(title = "Fagales",
         x = "Amino Acid Position",
         y = "omega dN/dS")

# Save the plot to a file
ggsave("../output/QvFLS2_omega.pdf", plot = p, width = 10, height = 5, dpi = 300)

# Print the plot to the R console
print(p)

```


#### Combined Curves
```{r}
library(ggplot2)
library(zoo)
library(dplyr)

# Function to read data and calculate sliding average
read_and_smooth <- function(file_path, window_size) {
  # Read the CSV file
  omega <- read.csv(file_path)
  
  # Calculate the sliding window average
  omega$Sliding_Average <- zoo::rollapply(omega$dN.dS, 
                                           width = window_size, 
                                           by = 1, 
                                           FUN = mean, 
                                           align = 'center', 
                                           fill = NA)
  # Add a column for the group (file identifier)
  omega$Group <- gsub(".*?/(.*)\\.csv$", "\\1", file_path)
  
  return(omega)
}

# Define the window size for smoothing
window_size <- 75

# Read and smooth data from all CSV files
files <- c("../input/fagales_omega.csv", "../input/brassicales_omega.csv", "../input/rosales_omega.csv")
omega_data <- lapply(files, function(f) read_and_smooth(f, window_size))

# Combine all data frames into one
omega_data_combined <- do.call(rbind, omega_data)

write.csv(omega_data_combined, file = "../output/combined_omega.csv")

# Define the custom ggplot theme
my_ggplot_theme <- theme_linedraw() +
  theme(text = element_text(size = 16),
        axis.title.x = element_text(size = 14, color = "black"),
        axis.title.y = element_text(size = 14, color = "black"),
        axis.text.x = element_text(size = 12, color = "black"),
        axis.text.y = element_text(size = 14, color = "black"),
        axis.ticks = element_line(size = 0.8),
        axis.ticks.length.y = unit(1.5, "mm"),
        plot.background = element_rect(fill = "white"),
        panel.grid = element_blank(), 
        panel.border = element_rect(color = "black", size = 0.8))

# Create the plot with smooth curves for each dataset
p <- ggplot(omega_data_combined, aes(x = pos, y = Sliding_Average, color = Group)) +
  #geom_line(size = 1.1) + 
  #geom_smooth(se = FALSE, method = "loess", span = 0.3) +
  geom_line(size = 1.1) + 
  #geom_smooth(se = FALSE, method = "loess", span = 0.01) +
  my_ggplot_theme +
  scale_x_continuous(breaks = seq(100, 700, by = 100)) +
  labs(title = "dN/dS Across Plant orders",
       x = "Amino Acid Position",
       y = " dN/dS",
       color = "Plant order") +  # Update the legend title
  scale_color_manual(values = c( "#66C2A5", "#C84D4C","#8DA0CB", "#D55E00"),
                     labels = c("Brassicales order", "Fagales order", "Rosales order"))  # Update the legend labels

# Save the plot to a file
ggsave("../output/combined_omega_curves.pdf", plot = p, width = 13, height = 4, dpi = 300)

# Print the plot to the R console
print(p)

```


```{r}
write.csv(omega_data_combined, file = "../output/combined_omega.csv")
```

```{r}
# Load necessary libraries
library(ggplot2)
library(dplyr)

# Read the data
data <- read.csv("../output/combined_omega.csv")

# Function to extract data for a specified range and group
extract_data <- function(data, group_name, start_pos, end_pos) {
  data %>%
    filter(Group == group_name & pos >= start_pos & pos <= end_pos) %>%
    mutate(relative_pos = pos - start_pos + 1) # Create a new column for relative position (1 to 24)
}

# Define ranges for each group
fagales_range <- c(101, 124)
brassicales_range <- c(121, 144)
rosales_range <- c(151, 174)

# Extract data for each range
fagales_data <- extract_data(data, "input/fagales_omega", fagales_range[1], fagales_range[2])
brassicales_data <- extract_data(data, "input/brassicales_omega", brassicales_range[1], brassicales_range[2])
rosales_data <- extract_data(data, "input/rosales_omega", rosales_range[1], rosales_range[2])

# Combine extracted data and set custom colors
combined_data <- rbind(
  fagales_data %>% mutate(Group = "Fagales"),
  brassicales_data %>% mutate(Group = "Brassicales"),
  rosales_data %>% mutate(Group = "Rosales")
) %>% 
  mutate(color = ifelse(`dN.dS` > 1, case_when(
    Group == "Brassicales" ~ "#66C2A5",
    Group == "Fagales" ~ "#C84D4C",
    Group == "Rosales" ~ "#8DA0CB"
  ), case_when(
    Group == "Brassicales" ~ "gray70",
    Group == "Fagales" ~ "gray65",
    Group == "Rosales" ~ "gray60"
  )))

# Plot with custom color rules and a red line for dN/dS = 1
ggplot(combined_data, aes(x = relative_pos, y = `dN.dS`, fill = color)) +
  geom_bar(stat = "identity", position = position_dodge(), width = 0.5) +
  geom_hline(yintercept = 1, color = "red", linetype = "dashed") +
  scale_fill_identity() + # Use the actual colors specified in the data frame
  scale_x_continuous(expand = c(0, 0), breaks = 1:24, labels = 1:24) + # X-axis labeled from 1 to 24
  scale_y_continuous(expand = c(0, 0)) + # Remove padding in y-axis
  labs(x = "Amino Acid Position", y = "dN/dS Value") +
  theme_classic() +
  theme(legend.position = "right")
ggsave("../output/omega_region_1.pdf", width = 6, height = 3)

```

####Load RCM output matrix

```{r}
# Load necessary library
library(reshape2)

# Read the data from the file
file_path <- "../input/until Carpinus_viminea.txt" # Replace path_to_your_file with the actual path
rcm <- read.csv(file_path, header = FALSE, sep = ",", strip.white = TRUE)

# Convert the data frame to a vector of values
values <- as.numeric(unlist(rcm))

# Ensure the length of values is compatible with a 14x28 matrix
if (length(values) != 14*28) {
  stop("The number of values in the file does not match the expected size of a 14x28 matrix.")
}

# Reshape the vector into a matrix
matrix_rcm <- matrix(values, ncol = 14, byrow = TRUE)

# If you need to manipulate or analyze the matrix, you can do so here.

# Optionally, write the matrix to a new CSV file if needed
write.csv(matrix_rcm, "../output/matrix_output.csv", row.names = FALSE)

```

####Plot the RCM plot

```{r}
# Load required libraries
library(ggplot2)
library(reshape2)  # For melt function
library(paletteer)

# Read the matrix data
matrix_rcm <- read.csv("../output/matrix_output.csv", header = TRUE)

# Create a new column 'Row' to preserve the row index before melting
matrix_rcm$Row <- seq_len(nrow(matrix_rcm))

# Melt the data for use with ggplot, with 'Row' as the id variable
matrix_melted <- melt(matrix_rcm, id.vars = 'Row')

# Define the color scale with blue for minimum and yellow for maximum
#blue_yellow_scale <- scale_fill_gradient2(low = "blue", mid = "green", high = "yellow", midpoint = 4, space = "Lab", transform = "identity")

# Create the heatmap
heatmap_plot <- ggplot(matrix_melted, aes(variable, Row, fill = value)) +
   geom_raster(interpolate = TRUE) +
  geom_tile(color = "darkgrey") +
  #blue_yellow_scale+
  #paletteer::scale_fill_paletteer_c("ggthemes::Orange-Blue Diverging", direction = -1) +
  #paletteer::scale_fill_paletteer_c("grDevices::RdYlBu", direction = -1) +
  #paletteer::scale_fill_paletteer_c("grDevices::Spectral", direction = -1) +
 # paletteer::scale_fill_paletteer_c("oompaBase::blueyellow", direction = 1) +
  #paletteer::scale_fill_paletteer_c("grDevices::topo.colors", direction = 1) +
  #paletteer::scale_fill_paletteer_c("grDevices::Plasma", direction = 1) +  # this is good
   #paletteer::scale_fill_paletteer_c("grDevices::ag_Sunset", direction = 1) +  # this is good
  # paletteer::scale_fill_paletteer_c("grDevices::YlOrRd", direction = 1) + # this is good
  #paletteer::scale_fill_paletteer_c("grDevices::YlGnBu", direction = 1) + # this is good
    #paletteer::scale_fill_paletteer_c("oompaBase::jetColors", direction = 1) + # this is perfect
    #paletteer::scale_fill_paletteer_c("pals::kovesi.linear_bgy_10_95_c74", direction = 1) + # this is okay
  paletteer::scale_fill_paletteer_c("viridis::viridis", direction = 1) + # this is perfect
  scale_x_discrete(expand = c(0, 0)) + # No space for X axis
  scale_y_continuous(trans = 'reverse', breaks = 1:28, labels = 1:28, expand = c(0, 0)) + # No space for Y axis
  geom_vline(xintercept = 6.5, size = 0.7, color = "black") + # Thick line between V6 and V7
  geom_vline(xintercept = 12.5, size = 0.7, color = "black") + # Thick line between V13 and V14
  #coord_fixed(ratio = 1) + # This ensures that tiles are square if that's desired
  theme_classic() + # Use a minimal theme
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), # Adjust the angle of x axis labels if needed
    axis.text.y = element_text(angle = 0), # Adjust the angle of y axis labels if needed
    panel.grid.major = element_blank(), # Remove major grid lines
    panel.grid.minor = element_blank(), # Remove minor grid lines
    panel.border = element_blank(), # Remove panel border
    plot.background = element_blank(), # Remove plot background
    panel.background = element_blank(), # Remove panel background
        legend.position = "bottom", # Move legend to bottom
    legend.direction = "horizontal" # Horizontal legend
  ) +
  labs(fill = "Conservation score") # Label for the legend
    #axis.ticks = element_blank() # Remove axis ticks
   
  #labs(title = "Heatmap with Custom Color Gradient", x = "Column", y = "Row", fill = "Value")

# Print the heatmap
print(heatmap_plot)
ggsave("../output/RCM_Qv.pdf", width = 3.7, height = 5)
```


``{r}
library(ggplot2)
library(zoo)
library(dplyr)

# Function to read data and calculate sliding average
read_and_smooth <- function(file_path, window_size) {
  # Read the CSV file
  omega <- read.csv(file_path)
  
  # Calculate the sliding window average
  omega$Sliding_Average <- zoo::rollapply(omega$dN.dS, 
                                           width = window_size, 
                                           by = 1, 
                                           FUN = mean, 
                                           align = 'center', 
                                           fill = NA)
  # Add a column for the group (file identifier)
  omega$Group <- gsub(".*?/(.*)\\.csv$", "\\1", file_path)
  
  return(omega)
}

# Define the window size for smoothing
window_size <- 15

# Read and smooth data from all CSV files
files <- c("../input/fagales_omega.csv", "../input/brassicales_omega.csv", "../input/rosales_omega.csv")
omega_data <- lapply(files, function(f) read_and_smooth(f, window_size))

# Combine all data frames into one
omega_data_combined <- do.call(rbind, omega_data)

# Define the custom ggplot theme
my_ggplot_theme <- theme_linedraw() +
  theme(text = element_text(size = 16, family = "Helvetica"),
        axis.title.x = element_text(size = 14, color = "black", family = "Helvetica"),
        axis.title.y = element_text(size = 14, color = "black", family = "Helvetica"),
        axis.text.x = element_text(size = 12, color = "black", family = "Helvetica"),
        axis.text.y = element_text(size = 14, color = "black", family = "Helvetica"),
        axis.ticks = element_line(size = 0.8),
        axis.ticks.length.y = unit(1.5, "mm"),
        plot.background = element_rect(fill = "white"),
        panel.grid = element_blank(), 
        panel.border = element_rect(color = "black", size = 0.8))

# Create the plot with smooth curves for each dataset
p <- ggplot(omega_data_combined, aes(x = pos, y = dN.dS, color = Group)) +
  #geom_line(size = 1.0) + # Adjust this value to make the line thicker
  geom_smooth(se = FALSE, method = "loess", span = 0.27) +
  my_ggplot_theme +
  scale_x_continuous(breaks = seq(100, 700, by = 100)) +
  labs(title = "Omega dN/dS Across Groups",
       x = "Amino Acid Position",
       y = "omega dN/dS") +
  scale_color_manual(values = c("red", "blue", "green", "purple")) # Customize the colors

# Save the plot to a file
ggsave("../output/combined_omega_curves.pdf", plot = p, width = 10, height = 5, dpi = 300)

# Print the plot to the R console
print(p)


```
